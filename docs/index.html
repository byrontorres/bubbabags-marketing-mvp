<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubbabags Marketing Platform - Arquitectura Técnica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Tabs Navigation */
        .tabs-container {
            background: #34495e;
            display: flex;
            overflow-x: auto;
            border-bottom: 3px solid #2c3e50;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: white;
            padding: 20px 30px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.1);
        }

        .tab-button.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }

        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* BPMN Style Diagrams */
        .bpmn-diagram {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 30px;
            margin: 30px 0;
            overflow-x: auto;
        }

        .bpmn-swimlane {
            display: flex;
            align-items: center;
            margin: 20px 0;
            min-height: 120px;
        }

        .swimlane-label {
            background: #34495e;
            color: white;
            padding: 10px 15px;
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            font-weight: bold;
            border-radius: 4px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swimlane-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 0 20px;
        }

        .bpmn-node {
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .bpmn-node.start {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #27ae60;
            color: white;
            border-color: #27ae60;
            font-weight: bold;
        }

        .bpmn-node.end {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
            font-weight: bold;
        }

        .bpmn-node.task {
            background: #ecf0f1;
            border-color: #34495e;
        }

        .bpmn-node.gateway {
            transform: rotate(45deg);
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f39c12;
            border-color: #f39c12;
        }

        .bpmn-node.gateway span {
            transform: rotate(-45deg);
            color: white;
            font-weight: bold;
        }

        .bpmn-node.data {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .bpmn-node-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #2c3e50;
        }

        .bpmn-node-desc {
            font-size: 0.75em;
            color: #5a6c7d;
            margin-top: 5px;
        }

        .bpmn-arrow {
            color: #34495e;
            font-size: 2em;
            font-weight: bold;
        }

        /* Code Examples */
        .code-example {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            margin: 20px 0;
        }

        .code-example .comment {
            color: #95a5a6;
        }

        .code-example .keyword {
            color: #3498db;
        }

        .code-example .string {
            color: #2ecc71;
        }

        .code-example .function {
            color: #e67e22;
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.85em;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table .highlight {
            background: #fff3cd;
            font-weight: bold;
        }

        .table-label {
            background: #34495e;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            margin-top: 30px;
            border-radius: 4px 4px 0 0;
        }

        /* Section Styles */
        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .section-subtitle {
            font-size: 1.3em;
            color: #34495e;
            margin: 30px 0 15px 0;
            font-weight: 600;
        }

        .info-box {
            background: #e8f5e9;
            border-left: 4px solid #27ae60;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .tech-stack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .tech-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .tech-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: #3498db;
        }

        .tech-icon {
            font-size: 2em;
            margin-bottom: 10px;
            color: #3498db;
        }

        .tech-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .tech-role {
            font-size: 0.85em;
            color: #5a6c7d;
        }

        /* Metrics */
        .metrics-row {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .metric-box {
            flex: 1;
            min-width: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Footer */
        .footer {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .bpmn-swimlane {
                flex-direction: column;
            }
            
            .swimlane-label {
                writing-mode: horizontal-tb;
                transform: none;
                width: 100%;
            }

            .swimlane-content {
                flex-direction: column;
                width: 100%;
            }
        }

        /* Process Flow Diagram */
        .process-flow {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .flow-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .flow-box {
            flex: 1;
            background: white;
            border: 2px solid #3498db;
            border-radius: 6px;
            padding: 15px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .flow-box h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .flow-box p {
            font-size: 0.85em;
            color: #5a6c7d;
        }

        .flow-connector {
            font-size: 2em;
            color: #3498db;
        }

        .collapsible {
            background: #ecf0f1;
            color: #2c3e50;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 4px;
            margin: 10px 0;
            transition: 0.3s;
        }

        .collapsible:hover {
            background: #d5dbdb;
        }

        .collapsible:after {
            content: '\25BC';
            float: right;
            margin-left: 5px;
        }

        .collapsible.active:after {
            content: '\25B2';
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: white;
            border-left: 3px solid #3498db;
            padding: 0 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Bubbabags Marketing Intelligence Platform</h1>
            <p>Arquitectura Técnica y Flujos de Trabajo</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <button class="tab-button active" onclick="openTab(event, 'overview')">Visión General</button>
            <button class="tab-button" onclick="openTab(event, 'bpmn')">Flujo BPMN</button>
            <button class="tab-button" onclick="openTab(event, 'data')">Capa de Datos</button>
            <button class="tab-button" onclick="openTab(event, 'ml')">Machine Learning</button>
            <button class="tab-button" onclick="openTab(event, 'n8n')">Automatización n8n</button>
            <button class="tab-button" onclick="openTab(event, 'code')">Ejemplos de Código</button>
            <button class="tab-button" onclick="openTab(event, 'tech')">Stack Técnico</button>
        </div>

        <!-- TAB 1: OVERVIEW -->
        <div id="overview" class="tab-content active">
            <h2 class="section-title">1. Visión General del Sistema</h2>
            
            <div class="info-box">
                <h3>Problema de Negocio</h3>
                <p><strong>Dolores actuales:</strong> Datos dispersos en GA4, Google Ads y Meta Ads consolidados en BigQuery pero difíciles de explotar. Dependencia de analistas SQL para preguntas simples. Falta de visión predictiva para optimizar inversión futura.</p>
            </div>

            <div class="info-box">
                <h3>Solución Implementada</h3>
                <p>Plataforma de inteligencia de marketing que combina análisis conversacional con OpenAI, predicción ROAS con XGBoost y automatización via n8n + Telegram Bot.</p>
            </div>

            <h3 class="section-subtitle">Métricas del Sistema</h3>
            <div class="metrics-row">
                <div class="metric-box">
                    <div class="metric-label">Impresiones Procesadas</div>
                    <div class="metric-value">157M</div>
                    <div class="metric-label">Google Ads + Meta Ads</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Campañas Activas</div>
                    <div class="metric-value">70</div>
                    <div class="metric-label">Multi-canal</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">R² del Modelo</div>
                    <div class="metric-value">0.684</div>
                    <div class="metric-label">XGBoost ROAS</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Mejora vs Baseline</div>
                    <div class="metric-value">+24%</div>
                    <div class="metric-label">Predicción ML</div>
                </div>
            </div>

            <h3 class="section-subtitle">Arquitectura en Capas</h3>
            <div class="process-flow">
                <div class="flow-row">
                    <div class="flow-box" style="background: #e8f5e9; border-color: #27ae60;">
                        <h4>Capa de Interfaz</h4>
                        <p>Streamlit UI | Telegram Bot | n8n Workflows</p>
                    </div>
                </div>
                <div style="text-align: center; font-size: 2em; color: #34495e;">↓</div>
                <div class="flow-row">
                    <div class="flow-box" style="background: #e3f2fd; border-color: #2196f3;">
                        <h4>Capa de API</h4>
                        <p>FastAPI (Puerto 8002) | 6 Endpoints REST</p>
                    </div>
                </div>
                <div style="text-align: center; font-size: 2em; color: #34495e;">↓</div>
                <div class="flow-row">
                    <div class="flow-box" style="background: #fff3e0; border-color: #ff9800;">
                        <h4>Capa de Inteligencia</h4>
                        <p>OpenAI GPT-4o-mini | Function Calling | Agente Conversacional</p>
                    </div>
                </div>
                <div style="text-align: center; font-size: 2em; color: #34495e;">↓</div>
                <div class="flow-row">
                    <div class="flow-box" style="background: #f3e5f5; border-color: #9c27b0;">
                        <h4>Capa de ML</h4>
                        <p>XGBoost | Scikit-learn | Predicción ROAS</p>
                    </div>
                </div>
                <div style="text-align: center; font-size: 2em; color: #34495e;">↓</div>
                <div class="flow-row">
                    <div class="flow-box" style="background: #fce4ec; border-color: #e91e63;">
                        <h4>Capa de Datos</h4>
                        <p>Google BigQuery | GA4 | Google Ads | Meta Ads</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: BPMN FLOW -->
        <div id="bpmn" class="tab-content">
            <h2 class="section-title">2. Flujo BPMN - Proceso Completo</h2>
            
            <h3 class="section-subtitle">Flujo Usuario → Respuesta (End-to-End)</h3>
            
            <div class="bpmn-diagram">
                <div class="bpmn-swimlane">
                    <div class="swimlane-label">USUARIO</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node start">INICIO</div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Envía Pregunta</div>
                            <div class="bpmn-node-desc">Streamlit o Telegram</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">ORQUESTACIÓN</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">n8n Workflow</div>
                            <div class="bpmn-node-desc">Polling cada 30s</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node gateway"><span>IF</span></div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">HTTP POST</div>
                            <div class="bpmn-node-desc">/api/ask</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">API LAYER</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">FastAPI</div>
                            <div class="bpmn-node-desc">Puerto 8002</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">run_agent()</div>
                            <div class="bpmn-node-desc">Wrapper function</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">INTELIGENCIA</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">OpenAI Agent</div>
                            <div class="bpmn-node-desc">GPT-4o-mini</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node gateway"><span>¿QUÉ?</span></div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Function Call</div>
                            <div class="bpmn-node-desc">Tool selection</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">ANALYTICS / ML</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">get_channel_summary()</div>
                        </div>
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">predict_roas()</div>
                        </div>
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">get_top_campaigns()</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">DATA LAYER</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">BigQuery Views</div>
                            <div class="bpmn-node-desc">SQL Queries</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">GA4 + Ads Data</div>
                            <div class="bpmn-node-desc">157M records</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">RESPUESTA</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Generar Answer</div>
                            <div class="bpmn-node-desc">NL response</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Enviar a Usuario</div>
                            <div class="bpmn-node-desc">Telegram/Streamlit</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node end">FIN</div>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <strong>Tiempo total del flujo:</strong> 3-5 segundos (Streamlit directo) | 30 segundos máximo (Telegram vía n8n polling)
            </div>
        </div>

        <!-- TAB 3: DATA LAYER -->
        <div id="data" class="tab-content">
            <h2 class="section-title">3. Capa de Datos - Vistas Lógicas</h2>
            
            <h3 class="section-subtitle">Concepto de Vistas Lógicas en Python</h3>
            <p>Las vistas lógicas son funciones Python que construyen queries SQL dinámicos para BigQuery y retornan DataFrames unificados.</p>

            <button class="collapsible">Ejemplo 1: Datos Raw en BigQuery</button>
            <div class="collapsible-content">
                <div class="table-label">Tabla: gads_campaign_daily (Google Ads)</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>date</th>
                            <th>campaign_id</th>
                            <th>campaign_name</th>
                            <th>impressions</th>
                            <th>clicks</th>
                            <th>cost</th>
                            <th>revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2024-04-01</td>
                            <td>101</td>
                            <td>Brand Search</td>
                            <td>1,000</td>
                            <td>100</td>
                            <td>50</td>
                            <td>300</td>
                        </tr>
                        <tr>
                            <td>2024-04-01</td>
                            <td>102</td>
                            <td>Prospecting</td>
                            <td>5,000</td>
                            <td>80</td>
                            <td>40</td>
                            <td>100</td>
                        </tr>
                        <tr>
                            <td>2024-04-02</td>
                            <td>101</td>
                            <td>Brand Search</td>
                            <td>800</td>
                            <td>90</td>
                            <td>45</td>
                            <td>270</td>
                        </tr>
                    </tbody>
                </table>

                <div class="table-label">Tabla: meta_ads_insights_daily (Meta Ads)</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>date</th>
                            <th>campaign_id</th>
                            <th>campaign_name</th>
                            <th>impressions</th>
                            <th>clicks</th>
                            <th>cost</th>
                            <th>revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2024-04-01</td>
                            <td>201</td>
                            <td>Meta Remarketing</td>
                            <td>2,000</td>
                            <td>60</td>
                            <td>30</td>
                            <td>180</td>
                        </tr>
                        <tr>
                            <td>2024-04-02</td>
                            <td>201</td>
                            <td>Meta Remarketing</td>
                            <td>1,500</td>
                            <td>50</td>
                            <td>25</td>
                            <td>150</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button class="collapsible">Ejemplo 2: Vista Lógica Unificada</button>
            <div class="collapsible-content">
                <h4>Función Python: get_campaign_performance_daily()</h4>
                <p>Archivo: <code>src/data/views.py</code></p>
                
                <div class="code-example">
<span class="keyword">def</span> <span class="function">get_campaign_performance_daily</span>(start_date: str, end_date: str) -> pd.DataFrame:
    <span class="comment"># Construye query que une Google Ads y Meta Ads</span>
    query = <span class="string">f"""
    WITH google AS (
        SELECT
            date,
            CAST(campaign_id AS STRING) AS campaign_id,
            campaign_name,
            'google' AS channel,
            impressions, clicks, cost, revenue
        FROM `{PROJECT}.{DATASET}.gads_campaign_daily`
        WHERE date BETWEEN '{start_date}' AND '{end_date}'
    ),
    meta AS (
        SELECT
            date,
            CAST(campaign_id AS STRING) AS campaign_id,
            campaign_name,
            'meta' AS channel,
            impressions, clicks, cost, revenue
        FROM `{PROJECT}.{DATASET}.meta_ads_insights_daily`
        WHERE date BETWEEN '{start_date}' AND '{end_date}'
    )
    SELECT
        date, campaign_id, campaign_name, channel,
        impressions, clicks, cost, revenue,
        SAFE_DIVIDE(revenue, cost) AS roas
    FROM (SELECT * FROM google UNION ALL SELECT * FROM meta)
    ORDER BY date, channel
    """</span>
    
    <span class="keyword">return</span> <span class="function">execute_query</span>(query)</div>

                <div class="table-label">Resultado: Vista Unificada</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>date</th>
                            <th>campaign_id</th>
                            <th>campaign_name</th>
                            <th>channel</th>
                            <th>impressions</th>
                            <th>clicks</th>
                            <th>cost</th>
                            <th>revenue</th>
                            <th class="highlight">roas</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2024-04-01</td>
                            <td>101</td>
                            <td>Brand Search</td>
                            <td>google</td>
                            <td>1,000</td>
                            <td>100</td>
                            <td>50</td>
                            <td>300</td>
                            <td class="highlight">6.00</td>
                        </tr>
                        <tr>
                            <td>2024-04-01</td>
                            <td>102</td>
                            <td>Prospecting</td>
                            <td>google</td>
                            <td>5,000</td>
                            <td>80</td>
                            <td>40</td>
                            <td>100</td>
                            <td class="highlight">2.50</td>
                        </tr>
                        <tr>
                            <td>2024-04-01</td>
                            <td>201</td>
                            <td>Meta Remarketing</td>
                            <td>meta</td>
                            <td>2,000</td>
                            <td>60</td>
                            <td>30</td>
                            <td>180</td>
                            <td class="highlight">6.00</td>
                        </tr>
                    </tbody>
                </table>

                <div class="info-box">
                    <strong>Ventaja:</strong> El agente conversacional o la API puede obtener datos unificados de múltiples fuentes con una sola llamada a <code>get_campaign_performance_daily("2024-04-01", "2024-04-02")</code>
                </div>
            </div>

            <button class="collapsible">Ejemplo 3: Cliente BigQuery</button>
            <div class="collapsible-content">
                <h4>Archivo: src/data/bigquery_client.py</h4>
                
                <div class="code-example">
<span class="keyword">from</span> google.cloud <span class="keyword">import</span> bigquery
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache

<span class="comment"># Cache del cliente para reutilización</span>
<span class="keyword">@lru_cache()</span>
<span class="keyword">def</span> <span class="function">get_bigquery_client</span>() -> bigquery.Client:
    <span class="keyword">return</span> bigquery.Client(project=settings.gcp_project_id)

<span class="keyword">def</span> <span class="function">execute_query</span>(query: str) -> pd.DataFrame:
    <span class="comment"># Ejecuta query y retorna DataFrame</span>
    client = <span class="function">get_bigquery_client</span>()
    <span class="keyword">return</span> client.query(query).to_dataframe()</div>

                <div class="info-box">
                    <strong>Beneficio:</strong> Abstracción completa de BigQuery. El resto del código solo necesita llamar <code>execute_query(sql)</code> sin preocuparse por autenticación o conexión.
                </div>
            </div>
        </div>

        <!-- TAB 4: ML LAYER -->
        <div id="ml" class="tab-content">
            <h2 class="section-title">4. Machine Learning - Pipeline ROAS</h2>
            
            <h3 class="section-subtitle">Flujo Completo de ML</h3>
            <div class="bpmn-diagram">
                <div class="bpmn-swimlane">
                    <div class="swimlane-label">EXTRACCIÓN</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node start">INICIO</div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">get_roas_training_dataset()</div>
                            <div class="bpmn-node-desc">BigQuery → DataFrame</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">FEATURE ENG.</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Winsorización</div>
                            <div class="bpmn-node-desc">Outliers</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Log Features</div>
                            <div class="bpmn-node-desc">log(cost), log(impr)</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Calendar Features</div>
                            <div class="bpmn-node-desc">day_of_week, month</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">TRAINING</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Split Temporal</div>
                            <div class="bpmn-node-desc">Train/Val/Test</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">XGBoost Training</div>
                            <div class="bpmn-node-desc">Google Ads</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Baseline (Ridge)</div>
                            <div class="bpmn-node-desc">Meta Ads</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">EVALUACIÓN</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">R² = 0.684</div>
                            <div class="bpmn-node-desc">XGBoost</div>
                        </div>
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">+24% vs Baseline</div>
                            <div class="bpmn-node-desc">Mejora</div>
                        </div>
                    </div>
                </div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">PERSISTENCIA</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Guardar Modelo</div>
                            <div class="bpmn-node-desc">JSON serialization</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">Guardar Métricas</div>
                            <div class="bpmn-node-desc">training_metrics.json</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node end">FIN</div>
                    </div>
                </div>
            </div>

            <button class="collapsible">Dataset de Entrenamiento con Features</button>
            <div class="collapsible-content">
                <div class="table-label">Dataset: roas_training_dataset (simplificado)</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>date</th>
                            <th>campaign_id</th>
                            <th>channel</th>
                            <th>impressions</th>
                            <th>clicks</th>
                            <th>cost</th>
                            <th>revenue</th>
                            <th class="highlight">roas</th>
                            <th>ctr</th>
                            <th>cpc</th>
                            <th>log_cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2024-04-01</td>
                            <td>101</td>
                            <td>google</td>
                            <td>1,000</td>
                            <td>100</td>
                            <td>50</td>
                            <td>300</td>
                            <td class="highlight">6.0</td>
                            <td>0.10</td>
                            <td>0.50</td>
                            <td>3.93</td>
                        </tr>
                        <tr>
                            <td>2024-04-01</td>
                            <td>102</td>
                            <td>google</td>
                            <td>5,000</td>
                            <td>80</td>
                            <td>40</td>
                            <td>100</td>
                            <td class="highlight">2.5</td>
                            <td>0.016</td>
                            <td>0.50</td>
                            <td>3.71</td>
                        </tr>
                        <tr>
                            <td>2024-04-01</td>
                            <td>201</td>
                            <td>meta</td>
                            <td>2,000</td>
                            <td>60</td>
                            <td>30</td>
                            <td>180</td>
                            <td class="highlight">6.0</td>
                            <td>0.03</td>
                            <td>0.50</td>
                            <td>3.43</td>
                        </tr>
                    </tbody>
                </table>

                <div class="info-box">
                    <strong>Features usadas para XGBoost:</strong> impressions, clicks, cost, ctr, cpc, log_cost, log_impressions, day_of_week, month, is_weekend
                    <br><strong>Target (y):</strong> roas
                </div>
            </div>

            <button class="collapsible">Código: Feature Engineering</button>
            <div class="collapsible-content">
                <h4>Archivo: src/modeling/features.py</h4>
                
                <div class="code-example">
<span class="keyword">def</span> <span class="function">build_features_dataframe</span>(lookback_days: int = 30) -> pd.DataFrame:
    <span class="comment"># 1. Obtener datos de BigQuery</span>
    df = <span class="function">get_roas_training_dataset</span>(lookback_days)
    
    <span class="comment"># 2. Features logarítmicas</span>
    df[<span class="string">"log_cost"</span>] = np.log1p(df[<span class="string">"cost"</span>])
    df[<span class="string">"log_impressions"</span>] = np.log1p(df[<span class="string">"impressions"</span>])
    
    <span class="comment"># 3. Features de calendario</span>
    df[<span class="string">"day_of_week"</span>] = pd.to_datetime(df[<span class="string">"date"</span>]).dt.dayofweek
    df[<span class="string">"month"</span>] = pd.to_datetime(df[<span class="string">"date"</span>]).dt.month
    df[<span class="string">"is_weekend"</span>] = (df[<span class="string">"day_of_week"</span>] >= 5).astype(int)
    
    <span class="comment"># 4. Features de ratios</span>
    df[<span class="string">"ctr"</span>] = df[<span class="string">"clicks"</span>] / df[<span class="string">"impressions"</span>]
    df[<span class="string">"cpc"</span>] = df[<span class="string">"cost"</span>] / df[<span class="string">"clicks"</span>]
    
    <span class="comment"># 5. Winsorización de outliers</span>
    df[<span class="string">"roas"</span>] = np.clip(df[<span class="string">"roas"</span>], 0, df[<span class="string">"roas"</span>].quantile(0.99))
    
    <span class="keyword">return</span> df</div>
            </div>

            <button class="collapsible">Código: Predicción en Producción</button>
            <div class="collapsible-content">
                <h4>Archivo: src/modeling/predict.py</h4>
                
                <div class="code-example">
<span class="keyword">def</span> <span class="function">predict_roas</span>(
    campaign_id: str,
    channel: str,
    current_metrics: dict
) -> float:
    <span class="comment">"""Predice ROAS dado ID de campaña y métricas actuales"""</span>
    
    <span class="comment"># 1. Cargar modelo entrenado</span>
    model = <span class="function">load_channel_model</span>(channel)
    
    <span class="comment"># 2. Construir features para predicción</span>
    features = <span class="function">prepare_features</span>(current_metrics)
    
    <span class="comment"># 3. Predecir ROAS</span>
    <span class="keyword">if</span> model:
        predicted_roas = model.predict(features)[0]
    <span class="keyword">else</span>:
        <span class="comment"># Fallback a baseline histórico</span>
        predicted_roas = <span class="function">get_baseline_roas</span>(campaign_id, channel)
    
    <span class="keyword">return</span> predicted_roas</div>

                <div class="info-box">
                    <strong>Uso en el agente:</strong> Cuando el usuario pregunta "¿Qué campañas tendrán mejor ROAS?", el agente llama <code>predict_roas()</code> para cada campaña y ordena por predicción.
                </div>
            </div>

            <h3 class="section-subtitle">Métricas del Modelo</h3>
            <div class="metrics-row">
                <div class="metric-box">
                    <div class="metric-label">R² Score</div>
                    <div class="metric-value">0.684</div>
                    <div class="metric-label">XGBoost (Google Ads)</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">MAE</div>
                    <div class="metric-value">3.42</div>
                    <div class="metric-label">Mean Absolute Error</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">RMSE</div>
                    <div class="metric-value">5.18</div>
                    <div class="metric-label">Root Mean Squared Error</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Mejora</div>
                    <div class="metric-value">+24%</div>
                    <div class="metric-label">vs Baseline Histórico</div>
                </div>
            </div>
        </div>

        <!-- TAB 5: N8N AUTOMATION -->
        <div id="n8n" class="tab-content">
            <h2 class="section-title">5. Automatización n8n - Telegram Bot</h2>
            
            <h3 class="section-subtitle">Arquitectura del Workflow</h3>
            
            <div class="bpmn-diagram">
                <div class="bpmn-swimlane">
                    <div class="swimlane-label">TRIGGER</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node start">SCHEDULE</div>
                        <div class="bpmn-node-desc" style="text-align: center; margin-top: 10px;">Cada 30 segundos</div>
                    </div>
                </div>

                <div style="text-align: center; font-size: 2em; color: #34495e;">↓</div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">GET MESSAGES</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">HTTP GET</div>
                            <div class="bpmn-node-desc">Telegram getUpdates</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">Último Mensaje</div>
                            <div class="bpmn-node-desc">offset=-1</div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; font-size: 2em; color: #34495e;">↓</div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">FILTER</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node gateway"><span>IF</span></div>
                        <div class="bpmn-node-desc" style="text-align: center; margin: 10px;">
                            message.date > (now - 30s)?
                        </div>
                    </div>
                </div>

                <div style="text-align: center; font-size: 2em; color: #34495e;">↓ TRUE</div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">PROCESS</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">HTTP POST</div>
                            <div class="bpmn-node-desc">api:8002/api/ask</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node data">
                            <div class="bpmn-node-label">Respuesta IA</div>
                            <div class="bpmn-node-desc">JSON answer</div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; font-size: 2em; color: #34495e;">↓</div>

                <div class="bpmn-swimlane">
                    <div class="swimlane-label">SEND RESPONSE</div>
                    <div class="swimlane-content">
                        <div class="bpmn-node task">
                            <div class="bpmn-node-label">HTTP POST</div>
                            <div class="bpmn-node-desc">Telegram sendMessage</div>
                        </div>
                        <div class="bpmn-arrow">→</div>
                        <div class="bpmn-node end">FIN</div>
                    </div>
                </div>
            </div>

            <button class="collapsible">Configuración: Schedule Trigger</button>
            <div class="collapsible-content">
                <div class="code-example">
<span class="comment"># Nodo: Schedule Trigger</span>
<span class="keyword">Trigger Interval:</span> Seconds
<span class="keyword">Seconds Between Triggers:</span> 30

<span class="comment"># Ejecuta workflow automáticamente cada 30 segundos</span>
<span class="comment"># Sin intervención manual</span></div>
            </div>

            <button class="collapsible">Configuración: IF Node (Anti-duplicados)</button>
            <div class="collapsible-content">
                <div class="code-example">
<span class="comment"># Nodo: IF Condition</span>
<span class="keyword">Value 1:</span> {{ $json.result[0].message.date }}
<span class="keyword">Operation:</span> is greater than
<span class="keyword">Value 2:</span> {{ Math.floor(Date.now() / 1000) - 30 }}

<span class="comment"># Lógica:</span>
<span class="comment"># Si message.date > (ahora - 30 segundos) → TRUE (procesar)</span>
<span class="comment"># Si message.date ≤ (ahora - 30 segundos) → FALSE (ignorar)</span>

<span class="comment"># Resultado: Solo mensajes nuevos se procesan</span>
<span class="comment"># Evita respuestas duplicadas</span></div>
            </div>

            <button class="collapsible">Configuración: POST /api/ask</button>
            <div class="collapsible-content">
                <div class="code-example">
<span class="comment"># Nodo: HTTP Request2</span>
<span class="keyword">Method:</span> POST
<span class="keyword">URL:</span> http://api:8002/api/ask
<span class="keyword">Content-Type:</span> application/json

<span class="comment"># Body (JSON):</span>
{
  <span class="string">"question"</span>: <span class="string">"{{ $('HTTP Request').item.json.result[0].message.text }}"</span>
}

<span class="comment"># Extrae el texto del mensaje de Telegram</span>
<span class="comment"># Lo envía al agente conversacional</span>
<span class="comment"># Recibe respuesta en JSON con campo "answer"</span></div>
            </div>

            <button class="collapsible">Configuración: Send Telegram Message</button>
            <div class="collapsible-content">
                <div class="code-example">
<span class="comment"># Nodo: HTTP Request1</span>
<span class="keyword">Method:</span> POST
<span class="keyword">URL:</span> https://api.telegram.org/bot{TOKEN}/sendMessage

<span class="comment"># Body (Using Fields Below):</span>
<span class="keyword">chat_id:</span> {{ $('HTTP Request').item.json.result[0].message.chat.id }}
<span class="keyword">text:</span> {{ $('HTTP Request2').item.json.answer }}

<span class="comment"># Envía respuesta del agente al usuario en Telegram</span>
<span class="comment"># chat_id: Identifica al usuario</span>
<span class="comment"># text: Respuesta generada por OpenAI</span></div>
            </div>

            <div class="warning-box">
                <strong>Decisión técnica:</strong> Polling vs Webhooks
                <p style="margin-top: 10px;">Se eligió <strong>polling cada 30 segundos</strong> en lugar de webhooks porque:</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Funciona en localhost sin configuración adicional</li>
                    <li>No requiere URL HTTPS pública</li>
                    <li>Ideal para MVP y desarrollo</li>
                    <li>Balance perfecto entre velocidad y recursos</li>
                </ul>
                <p style="margin-top: 10px;"><strong>Para producción escalada (V2):</strong> Migrar a webhooks para respuesta instantánea.</p>
            </div>
        </div>

        <!-- TAB 6: CODE EXAMPLES -->
        <div id="code" class="tab-content">
            <h2 class="section-title">6. Ejemplos de Código Completos</h2>
            
            <button class="collapsible">Ejemplo End-to-End: "Top 3 campañas por ROAS"</button>
            <div class="collapsible-content">
                <h4>Paso 1: Usuario pregunta en Telegram</h4>
                <div class="code-example">
<span class="comment"># Usuario escribe en Telegram:</span>
<span class="string">"Dame las top 3 campañas por ROAS predicho"</span></div>

                <h4 style="margin-top: 20px;">Paso 2: n8n captura el mensaje</h4>
                <div class="code-example">
<span class="comment"># HTTP Request a Telegram API</span>
GET https://api.telegram.org/bot{TOKEN}/getUpdates?offset=-1

<span class="comment"># Response:</span>
{
  <span class="string">"result"</span>: [{
    <span class="string">"message"</span>: {
      <span class="string">"date"</span>: 1732651200,
      <span class="string">"text"</span>: <span class="string">"Dame las top 3 campañas por ROAS predicho"</span>,
      <span class="string">"chat"</span>: {<span class="string">"id"</span>: 7692808796}
    }
  }]
}</div>

                <h4 style="margin-top: 20px;">Paso 3: n8n llama a la API</h4>
                <div class="code-example">
<span class="comment"># HTTP POST a FastAPI</span>
POST http://api:8002/api/ask
Content-Type: application/json

{
  <span class="string">"question"</span>: <span class="string">"Dame las top 3 campañas por ROAS predicho"</span>
}</div>

                <h4 style="margin-top: 20px;">Paso 4: FastAPI ejecuta el agente</h4>
                <div class="code-example">
<span class="comment"># src/api_simple.py</span>
<span class="keyword">@app.post</span>(<span class="string">"/api/ask"</span>)
<span class="keyword">async def</span> <span class="function">ask_question</span>(request: QuestionRequest):
    question = request.question
    
    <span class="comment"># Llamar al agente conversacional</span>
    <span class="keyword">from</span> src.agent.agent <span class="keyword">import</span> run_agent
    response = <span class="function">run_agent</span>(question)
    
    <span class="keyword">return</span> {
        <span class="string">"status"</span>: <span class="string">"success"</span>,
        <span class="string">"question"</span>: question,
        <span class="string">"answer"</span>: response
    }</div>

                <h4 style="margin-top: 20px;">Paso 5: Agente OpenAI procesa</h4>
                <div class="code-example">
<span class="comment"># src/agent/agent.py</span>
<span class="keyword">def</span> <span class="function">run_agent</span>(question: str) -> str:
    <span class="comment"># OpenAI interpreta pregunta</span>
    <span class="comment"># Decide usar herramienta: get_top_campaigns_by_predicted_roas()</span>
    
    <span class="comment"># Llama a la herramienta</span>
    tool_result = <span class="function">get_top_campaigns_by_predicted_roas</span>(limit=3)
    
    <span class="comment"># Formatea respuesta en lenguaje natural</span>
    answer = <span class="string">f"Las top 3 campañas por ROAS predicho son:
    1. {tool_result[0]['name']} - ROAS: {tool_result[0]['predicted_roas']}
    2. {tool_result[1]['name']} - ROAS: {tool_result[1]['predicted_roas']}
    3. {tool_result[2]['name']} - ROAS: {tool_result[2]['predicted_roas']}"</span>
    
    <span class="keyword">return</span> answer</div>

                <h4 style="margin-top: 20px;">Paso 6: Herramienta consulta datos + ML</h4>
                <div class="code-example">
<span class="comment"># Tool function</span>
<span class="keyword">def</span> <span class="function">get_top_campaigns_by_predicted_roas</span>(limit: int = 3):
    <span class="comment"># 1. Obtener campañas activas de BigQuery</span>
    df = <span class="function">get_campaign_performance_daily</span>(
        start_date=<span class="string">"2024-11-01"</span>,
        end_date=<span class="string">"2024-11-27"</span>
    )
    
    <span class="comment"># 2. Para cada campaña, predecir ROAS</span>
    predictions = []
    <span class="keyword">for</span> _, row <span class="keyword">in</span> df.iterrows():
        predicted_roas = <span class="function">predict_roas</span>(
            campaign_id=row[<span class="string">'campaign_id'</span>],
            channel=row[<span class="string">'channel'</span>],
            current_metrics=row.to_dict()
        )
        predictions.append({
            <span class="string">'campaign_id'</span>: row[<span class="string">'campaign_id'</span>],
            <span class="string">'name'</span>: row[<span class="string">'campaign_name'</span>],
            <span class="string">'predicted_roas'</span>: predicted_roas
        })
    
    <span class="comment"># 3. Ordenar por ROAS predicho y retornar top N</span>
    <span class="keyword">return</span> sorted(predictions, key=<span class="keyword">lambda</span> x: x[<span class="string">'predicted_roas'</span>], reverse=<span class="keyword">True</span>)[:limit]</div>

                <h4 style="margin-top: 20px;">Paso 7: Response a Telegram</h4>
                <div class="code-example">
<span class="comment"># n8n envía respuesta</span>
POST https://api.telegram.org/bot{TOKEN}/sendMessage

{
  <span class="string">"chat_id"</span>: 7692808796,
  <span class="string">"text"</span>: <span class="string">"Las top 3 campañas por ROAS predicho son:
1. marzo | metrix | conversiones - ROAS: 260.55
2. METRIX | PRODUCTOS Y OFERTAS - ROAS: 118.03
3. Metrix | Test | Catalogo Bubba - ROAS: 100.03"</span>
}</div>

                <h4 style="margin-top: 20px;">Paso 8: Usuario recibe respuesta</h4>
                <div class="info-box">
                    <strong>Tiempo total:</strong> ~5 segundos desde que el usuario envió la pregunta
                    <br><strong>Latencia n8n:</strong> Máximo 30 segundos adicionales por polling
                </div>
            </div>

            <button class="collapsible">Estructura de Archivos del Proyecto</button>
            <div class="collapsible-content">
                <div class="code-example">
bubbabags-mvp/
├── src/
│   ├── config.py              <span class="comment"># Configuración centralizada</span>
│   ├── api_simple.py          <span class="comment"># FastAPI con endpoints</span>
│   ├── agent/
│   │   └── agent.py           <span class="comment"># Agente OpenAI + function calling</span>
│   ├── data/
│   │   ├── bigquery_client.py <span class="comment"># Cliente BigQuery</span>
│   │   └── views.py           <span class="comment"># Vistas lógicas SQL</span>
│   └── modeling/
│       ├── features.py        <span class="comment"># Feature engineering</span>
│       ├── train.py           <span class="comment"># Entrenamiento XGBoost</span>
│       └── predict.py         <span class="comment"># Predicciones ROAS</span>
├── ui/
│   └── app.py                 <span class="comment"># Interfaz Streamlit</span>
├── models/
│   ├── roas_model_google_ads.json  <span class="comment"># Modelo entrenado</span>
│   └── training_metrics.json       <span class="comment"># Métricas del modelo</span>
├── docker/
│   ├── Dockerfile
│   └── docker-compose.yml     <span class="comment"># 3 servicios containerizados</span>
├── scripts/
│   ├── run_ui.py
│   └── train_model.py
├── .env                       <span class="comment"># Variables de entorno</span>
├── requirements.txt           <span class="comment"># Dependencias Python</span>
└── README.md</div>
            </div>
        </div>

        <!-- TAB 7: TECH STACK -->
        <div id="tech" class="tab-content">
            <h2 class="section-title">7. Stack Tecnológico Completo</h2>
            
            <div class="tech-stack-grid">
                <div class="tech-card">
                    <div class="tech-icon">▣</div>
                    <div class="tech-name">Python 3.12</div>
                    <div class="tech-role">Core Language</div>
                </div>
                <div class="tech-card">
                    <div class="tech-icon">⬢</div>
                    <div class="tech-name">BigQuery</div>
                    <div class="tech-role">Data Warehouse</div>
                </div>
                <div class="tech-card">
                    <div class="tech-icon">⚡</div>
                    <div class="tech-name">XGBoost</div>
                    <div class="tech-role">ML Framework</div>
                </div>
                <div class="tech-card">
                    <div class="tech-icon">◉</div>
                    <div class="tech-name">OpenAI</div>
                    <div class="tech-role">LLM Engine</div>
                </div>
                <div class="tech-card">
                    <div class="tech-icon">⚙</div>
                    <div class="tech-name">FastAPI</div>
                    <div class="tech-role">Backend API</div>
                </div>
                <div class="tech-card">
                    <div class="tech-icon">▦</div>
                    <div class="tech-name">Streamlit</div>
                    <div class="tech-role">Frontend UI</div>
                </div>
                <div class="tech-card">
                    <div class="tech-icon">◈</div>
                    <div class="tech-name">n8n</div>
                    <div class="tech-role">Automation</div>
                </div>
                <div class="tech-card">
                    <div class="tech-icon">◐</div>
                    <div class="tech-name">Docker</div>
                    <div class="tech-role">Containerization</div>
                </div>
            </div>

            <h3 class="section-subtitle">Matriz de Responsabilidades</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Componente</th>
                        <th>Tecnología</th>
                        <th>Puerto</th>
                        <th>Responsabilidad</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Frontend UI</td>
                        <td>Streamlit</td>
                        <td>8501</td>
                        <td>Dashboard interactivo, chat, visualizaciones</td>
                    </tr>
                    <tr>
                        <td>Backend API</td>
                        <td>FastAPI</td>
                        <td>8002</td>
                        <td>6 endpoints REST, integración n8n/Streamlit</td>
                    </tr>
                    <tr>
                        <td>Automation</td>
                        <td>n8n</td>
                        <td>5678</td>
                        <td>Orquestación Telegram Bot, workflows</td>
                    </tr>
                    <tr>
                        <td>Data Warehouse</td>
                        <td>BigQuery</td>
                        <td>Cloud</td>
                        <td>157M registros GA4 + Ads, vistas SQL</td>
                    </tr>
                    <tr>
                        <td>ML Engine</td>
                        <td>XGBoost</td>
                        <td>-</td>
                        <td>Predicción ROAS, R² 0.684</td>
                    </tr>
                    <tr>
                        <td>LLM Agent</td>
                        <td>OpenAI GPT-4o-mini</td>
                        <td>API</td>
                        <td>Interpretación NL, function calling</td>
                    </tr>
                    <tr>
                        <td>Chatbot</td>
                        <td>Telegram Bot API</td>
                        <td>HTTPS</td>
                        <td>Interfaz conversacional móvil</td>
                    </tr>
                    <tr>
                        <td>Infrastructure</td>
                        <td>Docker Compose</td>
                        <td>-</td>
                        <td>Orquestación de 3 servicios</td>
                    </tr>
                </tbody>
            </table>

            <h3 class="section-subtitle">Comandos Esenciales</h3>
            <div class="code-example">
<span class="comment"># Levantar todos los servicios</span>
docker-compose -f docker/docker-compose.yml up -d

<span class="comment"># Ver estado de servicios</span>
docker ps -a

<span class="comment"># Ver logs</span>
docker logs docker-api-1 --tail 50
docker logs docker-streamlit-1 --tail 50
docker logs docker-n8n-1 --tail 50

<span class="comment"># Re-entrenar modelo</span>
python scripts/train_model.py

<span class="comment"># Acceso a servicios</span>
<span class="string">Streamlit:</span>  http://localhost:8501
<span class="string">API:</span>        http://localhost:8002/docs
<span class="string">n8n:</span>        http://localhost:5678

<span class="comment"># Probar endpoint conversacional</span>
curl -X POST "http://localhost:8002/api/ask" \
     -H "Content-Type: application/json" \
     -d '{"question": "Cual canal tiene mejor ROAS?"}'</div>
        </div>

        <div class="footer">
            <p><strong>Bubbabags Marketing Intelligence Platform</strong></p>
            <p>Documentación Técnica - Versión 1.0</p>
            <p>Stack: Python 3.12 | BigQuery | XGBoost | OpenAI | FastAPI | Streamlit | n8n | Docker</p>
            <p style="margin-top: 10px;">Desarrollado por Byron Torres - Data Engineer</p>
        </div>
    </div>

    <script>
        // Tab switching
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // Collapsible sections
        var coll = document.getElementsByClassName("collapsible");
        for (var i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.maxHeight){
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        }
    </script>
</body>
</html>